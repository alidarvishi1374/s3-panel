<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <meta name="description" content="">
      <meta name="author" content="">
      <title>S3 Panel - IAM Users</title>
      <link rel="icon" type="image/svg" href="{{ url_for('static', filename='img/aws-logo.svg') }}">
      <!-- DataTables JS -->
      <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
      <!-- DataTables CSS -->
      <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
      <!-- Custom fonts for this template-->
      <link href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet" type="text/css">
      <link
         href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
         rel="stylesheet">
      <!-- Custom styles for this template-->
      <link href="{{ url_for('static', filename='css/sb-admin-2.min.css') }}" rel="stylesheet">
      <!-- SweetAlert2 -->
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <!-- CodeMirror -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
   </head>

   <style>
.btn-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    transition: all 0.3s ease;
}

.btn-circle:hover {
    transform: scale(1.1);
}
</style>
   <body id="page-top">
      <!-- Page Wrapper -->
      <div id="wrapper">
      <!-- Sidebar -->
      <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
         <!-- Sidebar - Brand -->
         <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
            <div class="sidebar-brand-icon rotate-n-13">
               <i class="fab fa-aws" style="color: orange;"></i>
            </div>
            <div class="sidebar-brand-text mx-3">S3 Panel</div>
         </a>
         <!-- Divider -->
         <hr class="sidebar-divider my-0">
         <!-- Nav Item - Dashboard -->
         <li class="nav-item">
            <a class="nav-link" href="{{ url_for('bucket.home') }}">
            <i class="fas fa-fw fa-tachometer-alt"></i>
            <span>Dashboard</span></a>
         </li>
         <!-- Divider -->
         <hr class="sidebar-divider">
         <!-- Heading -->
         <div class="sidebar-heading">
            Interface
         </div>
        <li class="nav-item">
    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseBuckets"
        aria-expanded="true" aria-controls="collapseBuckets">
        <i class="fa fa-cubes" aria-hidden="true"></i>
        <span>Buckets</span>
    </a>
    <div id="collapseBuckets" class="collapse" aria-labelledby="headingBuckets" data-parent="#accordionSidebar">
        <div class="bg-white py-2 collapse-inner rounded">
            <a class="collapse-item" href="{{ url_for('bucket.buckets') }}">Buckets</a>
        </div>
    </div>
</li>

<!-- Nav Item - Objects Collapse Menu -->
<li class="nav-item">
    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseObjects"
        aria-expanded="true" aria-controls="collapseObjects">
        <i class="fas fa-database"></i>
        <span>Objects</span>
    </a>
    <div id="collapseObjects" class="collapse" aria-labelledby="headingObjects" data-parent="#accordionSidebar">
        <div class="bg-white py-2 collapse-inner rounded">
            <a class="collapse-item" href="{{ url_for('objects.all_buckets') }}">Objects</a>
        </div>
    </div>
</li>

    <li class="nav-item">
      <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseS3select">
<i class="fas fa-table"></i><span>S3select</span>
      </a>
      <div id="collapseS3select" class="collapse">
        <div class="bg-white py-2 collapse-inner rounded">
          <a class="collapse-item" href="{{ url_for('s3_select.s3_select_page') }}">S3select</a>
        </div>
      </div>
    </li>
         <!-- Nav Item - Utilities Collapse Menu -->
         {% if user_info.type == "Root Account" %}
         <li class="nav-item active">
            <a class="nav-link" href="#" data-toggle="collapse" data-target="#collapseUtilities"
               aria-expanded="true" aria-controls="collapseUtilities">
            <i class="fa fa-key" aria-hidden="true"></i>
            <span>IAM</span>
            </a>
            <div id="collapseUtilities" class="collapse show" aria-labelledby="headingUtilities"
               data-parent="#accordionSidebar">
               <div class="bg-white py-2 collapse-inner rounded">
                  <a class="collapse-item active" href="{{ url_for('user.iam_users') }}">Users</a>
                  <a class="collapse-item" href="{{ url_for('iam_groups.iam_groups') }}">Groups</a>
               </div>
            </div>
         </li>
         {% endif %}

<li class="nav-item">
    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseSts"
        aria-expanded="true" aria-controls="collapseSts">
        <i class="fas fa-theater-masks"></i>
        <span>STS</span>
    </a>

    <div id="collapseSts" class="collapse" aria-labelledby="headingObjects" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
            {% if user_info.type == "Root Account" %}

            <a class="collapse-item" href="{{ url_for('manage.manage_sts_permissions') }}">Admin Permission</a>
            <a class="collapse-item" href="{{ url_for('manage_iam.manage_roles_page') }}">Role Management</a>
             {% endif %}
              {% if user_info.type != "Root Account" %}
              <a class="collapse-item" href="{{ url_for('assume_roles.assume_roles_page') }}">Assume Role</a">
              {% endif %}        
            </div>
    </div>
</li>

         <!-- Divider -->
         <hr class="sidebar-divider d-none d-md-block">
         <div class="sidebar-heading">User</div>
         <li class="nav-item">
            <a class="nav-link" href="{{ url_for('user.profile') }}">
            <i class="fas fa-fw fa-user"></i>
            <span>Profile</span>
            </a>
         </li>
         <!-- Sidebar Toggler (Sidebar) -->
         <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
         </div>
      </ul>
      <!-- End of Sidebar -->
      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
      <!-- Main Content -->
      <div id="content">
      <!-- Topbar -->
      <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
         <!-- Sidebar Toggle (Topbar) -->
         <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
         <i class="fa fa-bars"></i>
         </button>
         <!-- Topbar Navbar -->
         <ul class="navbar-nav ml-auto">
            <!-- Nav Item - User Information -->
            <li class="nav-item dropdown no-arrow">
               <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
               <span class="mr-2 d-none d-lg-inline text-gray-600 small">
               {{ user_info.UserName or "No Name" }}
               {% if user_info.type %}
               ({{ user_info.type }})
               {% endif %}
               </span>   
               <img class="img-profile rounded-circle"
                  src="{{ url_for('static', filename='img/undraw_profile.svg') }}">
               </a>
               <!-- Dropdown - User Information -->
               <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                  aria-labelledby="userDropdown">
                  <a class="dropdown-item" href="{{ url_for('user.profile') }}">
                  <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                  Profile
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                  <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                  Logout
                  </a>
               </div>
            </li>
         </ul>
      </nav>
      <!-- End of Topbar -->
      <!-- Begin Page Content -->
      <div class="container-fluid">
         <!-- Page Heading -->
         <h1 class="h3 mb-4 text-gray-800">IAM Users</h1>
         <!-- Content Row -->
         <div class="row">
            <div class="col-lg-12">
               <!-- Create User Button -->
               <div class="mb-3 text-right">
                  <button class="btn btn-success btn-lg shadow" data-toggle="modal" data-target="#createUserModal">
                  <i class="fas fa-user-plus"></i> Create User
                  </button>
               </div>
               
               <!-- Search Input -->
               <div class="mb-3">
                  <input type="text" id="searchUserInput" class="form-control" placeholder="Search by UserName...">
               </div>

               <!-- IAM Users Table -->
               <div class="card shadow-lg border-0 rounded-lg animate__animated animate__fadeIn">
                  <div class="card-header py-3 bg-gradient-primary text-white">
                     <h6 class="m-0 font-weight-bold">Users List</h6>
                  </div>
                  <div class="card-body">
                     <div class="table-responsive">
                        <table id="iamUsersTable" class="table table-hover table-striped table-bordered align-middle text-center">
                           <thead class="thead-dark">
                              <tr>
                                 <th>UserName</th>
                                 <th>ARN</th>
                                 <th>Create Date</th>
                                 <th>Active Keys</th>
                                 <th>Groups</th>
                                 <th>Inline Policies</th>
                                 <th>Attached Policies</th>
                                 <th>Actions</th>
                              </tr>
                           </thead>
                           <tbody>
                              {% for user in iam_users %}
                              <tr class="animate__animated animate__fadeInUp animate__faster">
                                 <td><span class="badge badge-info px-3 py-2">{{ user.UserName }}</span></td>
                                 <td class="text-break">{{ user.Arn }}</td>
                                 <td>{{ user.Created }}</td>
                                 <td>
                                    {% if user.ActiveKeysError %}
                                    <span class="badge badge-warning" title="{{ user.ActiveKeysError }}">Err</span>
                                    {% elif user.ActiveKeysCount is none %}
                                    <span class="badge badge-secondary">—</span>
                                    {% else %}
                                    {% if user.ActiveKeysCount > 0 %}
                                    <span class="badge badge-success">{{ user.ActiveKeysCount }}</span>
                                    {% else %}
                                    <span class="badge badge-secondary">0</span>
                                    {% endif %}
                                    {% endif %}
                                 </td>
                                 <td>
                                    {% if user.Groups %}
                                    {% for g in user.Groups %}
                                    <span class="badge badge-success mx-1">{{ g }}</span>
                                    {% endfor %}
                                    {% else %}
                                    <span class="badge badge-secondary">No Groups</span>
                                    {% endif %}
                                 </td>
                                 <td>
                                    <button class="btn btn-sm btn-info view-inline-policies-btn" data-username="{{ user.UserName }}">
                                       <i class="fas fa-file-code"></i> View
                                    </button>
                                 </td>
                                 <td>
                                    <button class="btn btn-sm btn-info view-attached-policies-btn" data-username="{{ user.UserName }}">
                                       <i class="fas fa-file-code"></i> View
                                    </button>
                                 </td>
                                 <td class="d-flex justify-content-center">
                                    <button class="btn btn-sm btn-outline-success flex-fill mx-1 manage-keys-btn" 
                                        data-username="{{ user.UserName }}">
                                        <i class="fas fa-key"></i> Manage keys
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill mx-1 delete-user-btn" 
                                        data-username="{{ user.UserName }}">
                                        <i class="fas fa-trash"></i> Delete User
                                    </button>
                                 </td>
                              </tr>
                              {% endfor %}
                           </tbody>
                        </table>
                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                           <div>
                              Show 
                              <select id="rowsPerPageSelect" class="form-control d-inline-block" style="width: auto;">
                                 <option value="5">5</option>
                                 <option value="10" selected>10</option>
                                 <option value="20">20</option>
                                 <option value="50">50</option>
                              </select>
                              entries
                           </div>
                           <nav>
                              <ul id="pagination" class="pagination mb-0"></ul>
                           </nav>
                        </div>
                     </div>
                  </div>
               </div>
               <!-- End IAM Users Table -->
            </div>
         </div>
      </div>
      <!-- End of Page Content -->
      <!-- Animate.css CDN -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
      </div>
      <!-- End of Content Wrapper -->
      </div>
      <!-- End of Page Wrapper -->
      
      <!-- Scroll to Top Button-->
      <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
      </a>

      <!-- Logout Modal-->
      <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
         <div class="modal-dialog" role="document">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                  <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                  </button>
               </div>
               <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
               <div class="modal-footer">
                  <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                  <a class="btn btn-primary" href="{{ url_for('auth.login') }}">Logout</a>
               </div>
            </div>
         </div>
      </div>

      <!-- Bootstrap core JavaScript-->
      <script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
      <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
      <script src="{{ url_for('static', filename='vendor/jquery-easing/jquery.easing.min.js') }}"></script>
      <script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>

      <!-- Create User Modal -->
      <div class="modal fade" id="createUserModal" tabindex="-1" role="dialog" aria-labelledby="createUserModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content shadow-lg border-0 rounded-lg">
               <div class="modal-header bg-gradient-primary text-white">
                  <h5 class="modal-title font-weight-bold" id="createUserModalLabel">
                     <i class="fas fa-user-plus"></i> Create New User
                  </h5>
                  <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                  </button>
               </div>
               <form id="createUserForm">
                  <div class="modal-body">
                     <!-- Username Input -->
                     <div class="form-group">
                        <label for="username" class="font-weight-bold">Username</label>
                        <input type="text" class="form-control" id="username" name="username" placeholder="Enter username..." required>
                     </div>
                     <!-- Region Input -->
                     <div class="form-group">
                        <label for="region" class="font-weight-bold">Region</label>
                        <select class="form-control" id="region" name="region" required>
                           <option value="" disabled selected>Select region</option>
                           <option value="us-east-1" selected>Default</option>
                           <option value="us-east-1">US East (N. Virginia)</option>
                           <option value="us-west-1">US West (N. California)</option>
                           <option value="eu-west-1">EU (Ireland)</option>
                           <option value="ap-south-1">Asia Pacific (Mumbai)</option>
                        </select>
                     </div>
                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="enablePanelAccess" name="enable_panel_access" checked>
                            <label class="custom-control-label font-weight-bold" for="enablePanelAccess">
                                Allow access to panel (Attach GetUser Policy)
                            </label>
                        </div>
                    </div>
                     <div id="createUserResult" class="mt-3"></div>
                  </div>
                  <div class="modal-footer">
                     <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                     <button type="submit" class="btn btn-success">
                     <i class="fas fa-check"></i> Create
                     </button>
                  </div>
               </form>
            </div>
         </div>
      </div>

      <!-- Manage Keys Modal -->
      <div class="modal fade" id="manageKeysModal" tabindex="-1" role="dialog" aria-labelledby="manageKeysModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content shadow-lg border-0 rounded-lg">
               <div class="modal-header bg-gradient-primary text-white">
                  <h5 class="modal-title font-weight-bold" id="manageKeysModalLabel">
                     <i class="fas fa-key"></i> Manage Keys - <span id="modalUsername"></span>
                  </h5>
                  <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                  </button>
               </div>
               <div class="modal-body">
                  <div id="keysLoading" class="text-center my-3">
                     <i class="fas fa-spinner fa-spin fa-2x"></i> Loading...
                  </div>
                  <div id="keysContent" class="d-none">
                     <table class="table table-hover table-bordered">
                        <thead class="thead-dark">
                           <tr>
                              <th>Access Key ID</th>
                              <th>Status</th>
                              <th>Created Date</th>
                              <th>Actions</th>
                           </tr>
                        </thead>
                        <tbody id="keysTableBody"></tbody>
                     </table>
                  </div>
               </div>
               <div class="modal-footer d-flex justify-content-between">
                  <button type="button" class="btn btn-success" id="createKeyBtn">
                  <i class="fas fa-plus"></i> Create Key
                  </button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
               </div>
            </div>
         </div>
      </div>

      <!-- Delete User Modal -->
      <div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="deleteUserModalLabel"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h5>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body text-center">
              Are you sure you want to delete user <strong id="deleteUsernameText"></strong>?
            </div>
            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger btn-sm" id="confirmDeleteUserBtn">Yes, Delete</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Inline Policies Modal for Users -->
      <div class="modal fade" id="userInlinePoliciesModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Inline Policies for <span id="policyUserName"></span></h5>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th>Policy Name</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="userInlinePoliciesTable"></tbody>
              </table>
              <button class="btn btn-success" id="addUserPolicyBtn">+ Add New Policy</button>
              <div id="userPolicyEditorSection" style="display:none; margin-top:20px;">
                <input type="text" id="userPolicyNameInput" class="form-control mb-2" placeholder="Policy Name">
                <textarea id="userPolicyDocumentInput" class="form-control" rows="10" placeholder="Enter JSON policy here"></textarea>
                <div class="mt-2">
                  <button class="btn btn-primary" id="saveUserPolicyBtn">Save</button>
                  <button class="btn btn-secondary" id="cancelUserPolicyBtn">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Attached Policies Modal for Users -->
      <div class="modal fade" id="userAttachedPoliciesModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Attached Policies - <span id="attachedUserName"></span></h5>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Policy Name</th>
                    <th>Policy ARN</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="userAttachedPoliciesTable"></tbody>
              </table>
              <hr>
              <h6>Attach New Policy</h6>
              <div class="form-group">
                <input type="text" id="newUserPolicyArn" class="form-control" placeholder="Enter Policy ARN">
              </div>
              <button id="attachUserPolicyBtn" class="btn btn-success">Attach Policy</button>
            </div>
          </div>
        </div>
      </div>

      <div id="customAlertContainer" class="position-fixed" style="top:20px; right:20px; z-index:9999; width:300px;"></div>

<script>
// ========== USER MANAGEMENT FUNCTIONS ==========
$(document).ready(function () {
    // Create User Form
    $("#createUserForm").submit(function (e) {
        e.preventDefault();
        const $form = $(this);
        const $submit = $form.find('button[type="submit"]');
        const $result = $("#createUserResult");
        $result.html('');
        $submit.prop('disabled', true);
        $submit.append(' <i class="fas fa-spinner fa-spin submit-spinner"></i>');

        const data = {
            username: $("#username").val(),
            region: $("#region").val(),
            enable_panel_access: $("#enablePanelAccess").is(":checked")
        };

        $.ajax({
            type: "POST",
            url: "{{ url_for('user.create_user') }}",
            data: data,
            success: function (response) {
                if (response && response.success) {
                    localStorage.setItem("userCreatedMsg", response.message || 'User created');
                    $form[0].reset();
                    $('#createUserModal').modal('hide');
                    $('#createUserModal').one('hidden.bs.modal', function () {
                        location.reload();
                    });
                } else {
                    const msg = (response && response.message) ? response.message : 'Error creating user.';
                    $result.html('<div class="alert alert-danger mb-0">' + msg + '</div>');
                }
            },
            error: function (xhr, status, err) {
                $result.html('<div class="alert alert-danger mb-0">خطا در برقراری ارتباط با سرور.</div>');
            },
            complete: function () {
                $submit.prop('disabled', false);
                $submit.find('.submit-spinner').remove();
            }
        });
    });

    // Manage Keys
    $(".manage-keys-btn").click(function () {
        const username = $(this).data("username");
        $("#modalUsername").text(username);
        $("#keysLoading").show();
        $("#keysContent").addClass("d-none");
        $("#keysTableBody").empty();
        $("#manageKeysModal").modal("show");

        $.ajax({
            url: "{{ url_for('user.get_keys') }}",
            method: "POST",
            data: { username: username },
            success: function (response) {
                $("#keysLoading").hide();
                if (response && response.keys && response.keys.length > 0) {
                    response.keys.forEach(key => {
                        const row = $(`
                            <tr>
                                <td>${key.AccessKeyId}</td>
                                <td>
                                    ${key.Status === "Active" 
                                        ? `<span class="badge badge-success px-2 py-1">Active</span>` 
                                        : `<span class="badge badge-secondary px-2 py-1">Inactive</span>`}
                                </td>
                                <td>${key.CreateDate}</td>
                                <td class="d-flex flex-column align-items-center">
                                    ${key.Status === "Active" 
                                        ? `<button class="btn btn-sm btn-warning mb-1 w-100 disable-key-btn" data-key="${key.AccessKeyId}" data-username="${username}">
                                                <i class="fas fa-toggle-off"></i> Disable
                                            </button>` 
                                        : `<button class="btn btn-sm btn-success mb-1 w-100 enable-key-btn" data-key="${key.AccessKeyId}" data-username="${username}">
                                                <i class="fas fa-toggle-on"></i> Enable
                                            </button>`}
                                    <button class="btn btn-sm btn-danger w-100 delete-key-btn" data-key="${key.AccessKeyId}" data-username="${username}">
                                        <i class="fas fa-trash-alt"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `);
                        $("#keysTableBody").append(row);
                    });
                    $("#keysContent").removeClass("d-none");
                } else {
                    $("#keysTableBody").append('<tr><td colspan="4" class="text-center">No keys found</td></tr>');
                    $("#keysContent").removeClass("d-none");
                }
            },
            error: function () {
                $("#keysLoading").hide();
                $("#keysTableBody").append('<tr><td colspan="4" class="text-center text-danger">Error fetching keys</td></tr>');
                $("#keysContent").removeClass("d-none");
            }
        });
    });

    // Key Actions
    $(document).on("click", ".disable-key-btn, .enable-key-btn, .delete-key-btn", function () {
        const keyId = $(this).data("key");
        const username = $(this).data("username");
        const action = $(this).hasClass("disable-key-btn") ? "disable" : $(this).hasClass("enable-key-btn") ? "enable" : "delete";

        $.ajax({
            url: "{{ url_for('user.modify_key') }}",
            method: "POST",
            data: { username: username, key_id: keyId, action: action },
            success: function (response) {
                if (response && response.success) {
                    $(".manage-keys-btn[data-username='" + username + "']").click();
                    showCustomAlert("Action completed successfully!", "success");
                } else {
                    const msg = response.message || "Failed to perform action!";
                    showCustomAlert(msg, "danger");
                }
            },
            error: function (xhr) {
                let msg = "Server error occurred!";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    msg = xhr.responseJSON.message;
                }
                showCustomAlert(msg, "danger");
            }
        });
    });

    // Delete User
    $(document).on("click", ".delete-user-btn", function () {
        const username = $(this).data("username");
        $("#deleteUsernameText").text(username);
        $("#confirmDeleteUserBtn").data("username", username);
        $("#deleteUserModal").modal("show");
    });

    $("#confirmDeleteUserBtn").click(function () {
        const username = $(this).data("username");
        fetch("/delete_user", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showCustomAlert(data.message, "success");
                setTimeout(() => location.reload(), 1000);
            } else {
                showCustomAlert(data.message, "danger");
            }
        })
        .catch(err => {
            showCustomAlert("Server error: " + err, "danger");
        });
        $("#deleteUserModal").modal("hide");
    });

    // Create Access Key
    $("#createKeyBtn").click(async function() {
        const username = $("#modalUsername").text();
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

        try {
            const res = await fetch("/create-access-key", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username })
            });
            const data = await res.json();

            if (data.success) {
                const tbody = document.getElementById("keysTableBody");
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${data.AccessKeyId}</td>
                    <td>Active</td>
                    <td>${data.CreateDate}</td>
                    <td>
                        <button class="btn btn-warning btn-sm disableKeyBtn" data-key="${data.AccessKeyId}">Disable</button>
                        <button class="btn btn-danger btn-sm deleteKeyBtn" data-key="${data.AccessKeyId}">Delete</button>
                    </td>
                `;
                tbody.prepend(row);
                showKeyAlert(data.AccessKeyId, data.SecretAccessKey);
            } else {
                showErrorAlert(data.message);
            }
        } catch (err) {
            showErrorAlert(err);
        } finally {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-plus"></i> Create Key';
        }
    });

// ========== INLINE POLICIES FOR USERS ==========
let currentUserName = null;
let editingUserPolicy = null;

// View Inline Policies
$(document).on("click", ".view-inline-policies-btn", function () {
    const username = $(this).data("username");
    viewUserInlinePolicies(username);
});

function viewUserInlinePolicies(username) {
    currentUserName = username;
    $("#policyUserName").text(username);

    $.getJSON(`/get_user_inline_policies?username=${username}`, function(resp) {
        if (resp.success) {
            let rows = "";
            resp.policies.forEach(p => {
                const encodedDoc = encodeURIComponent(JSON.stringify(p.PolicyDocument));
                rows += `
                  <tr>
                    <td>${p.PolicyName}</td>
                    <td>
                      <button class="btn btn-sm btn-info edit-user-policy-btn" 
                              data-policy-name="${p.PolicyName}" 
                              data-policy-doc="${encodedDoc}">Edit</button>
                      <button class="btn btn-sm btn-danger delete-user-policy-btn" 
                              data-policy-name="${p.PolicyName}">Delete</button>
                    </td>
                  </tr>`;
            });
            if (rows === "") {
                rows = `<tr><td colspan="2" class="text-center">No inline policies found</td></tr>`;
            }
            $("#userInlinePoliciesTable").html(rows);
        } else {
            $("#userInlinePoliciesTable").html(`<tr><td colspan="2">${resp.message}</td></tr>`);
        }
        $("#userInlinePoliciesModal").modal("show");
    });
}

// Edit User Policy با event delegation
$(document).on("click", ".edit-user-policy-btn", function() {
    const policyName = $(this).data("policy-name");
    const encodedDoc = $(this).data("policy-doc");
    
    try {
        const policyDoc = JSON.parse(decodeURIComponent(encodedDoc));
        editUserPolicy(policyName, policyDoc);
    } catch (e) {
        console.error("Error parsing policy document:", e);
        Swal.fire("Error", "Failed to parse policy document", "error");
    }
});

function editUserPolicy(name, doc) {
    editingUserPolicy = name;
    $("#userPolicyNameInput").val(name);
    
    $("#userPolicyDocumentInput").val(JSON.stringify(doc, null, 2));
    $("#userPolicyEditorSection").show();
}

$(document).on("click", ".delete-user-policy-btn", function() {
    const policyName = $(this).data("policy-name");
    deleteUserPolicy(policyName);
});

function deleteUserPolicy(name) {
    Swal.fire({
        title: "Delete Policy",
        text: `Are you sure you want to delete policy "${name}"?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "Cancel"
    }).then(result => {
        if (result.isConfirmed) {
            $.ajax({
                url: "/delete_user_inline_policy",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ 
                    username: currentUserName, 
                    policy_name: name 
                }),
                success: function(resp) {
                    if (resp.success) {
                        Swal.fire({
                            icon: "success",
                            title: `Policy "${name}" deleted`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        viewUserInlinePolicies(currentUserName);
                    } else {
                        Swal.fire("Error", resp.message || "Failed to delete policy", "error");
                    }
                },
                error: function(err) {
                    Swal.fire("Error", "AJAX error: " + err.statusText, "error");
                }
            });
        }
    });
}

// Add New User Policy
$("#addUserPolicyBtn").on("click", function() {
    editingUserPolicy = null;
    $("#userPolicyNameInput").val("");
    $("#userPolicyDocumentInput").val("");
    $("#userPolicyEditorSection").show();
});

// Cancel User Policy
$("#cancelUserPolicyBtn").on("click", function() {
    $("#userPolicyEditorSection").hide();
});

// Save User Policy
$("#saveUserPolicyBtn").on("click", function() {
    const name = $("#userPolicyNameInput").val().trim();
    const doc = $("#userPolicyDocumentInput").val().trim();

    if (!name || !doc) {
        Swal.fire("Error", "Please enter policy name and JSON document", "error");
        return;
    }

    let parsed;
    try {
        parsed = JSON.parse(doc);
    } catch (e) {
        Swal.fire("Invalid JSON", "Policy document must be valid JSON", "error");
        return;
    }

    const payload = {
        username: currentUserName,
        policy_name: name,
        policy_document: parsed
    };

    const url = editingUserPolicy ? "/update_user_inline_policy" : "/add_user_inline_policy";

    $.ajax({
        url: url,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(payload),
        success: function(resp) {
            if (resp.success) {
                Swal.fire({
                    icon: "success",
                    title: `Policy ${editingUserPolicy ? "updated" : "added"} successfully`,
                    timer: 2000,
                    showConfirmButton: false
                });
                $("#userPolicyEditorSection").hide();
                viewUserInlinePolicies(currentUserName);
            } else {
                Swal.fire("Error", resp.message || "Failed to save policy", "error");
            }
        },
        error: function(err) {
            Swal.fire("Error", "AJAX error: " + err.statusText, "error");
        }
    });
});

// ========== ATTACHED POLICIES FOR USERS ==========
let currentAttachedUserName = null;

// View Attached Policies
$(document).on("click", ".view-attached-policies-btn", function() {
    const username = $(this).data("username");
    openUserAttachedPoliciesModal(username);
});

function openUserAttachedPoliciesModal(username) {
    currentAttachedUserName = username;
    $("#attachedUserName").text(username);

    fetch(`/get_attached_user_policies?username=${username}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                let rows = "";
                data.policies.forEach(p => {
                    rows += `
                        <tr>
                            <td>${p.PolicyName}</td>
                            <td>${p.PolicyArn}</td>
                            <td>
                                <button class="btn btn-danger btn-sm detach-user-policy-btn" data-policy-arn="${p.PolicyArn}">
                                    <i class="fas fa-trash"></i> Detach
                                </button>
                            </td>
                        </tr>`;
                });
                $("#userAttachedPoliciesTable").html(rows || "<tr><td colspan='3'>No attached policies.</td></tr>");
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to load attached policies'
                });
            }
        });

    $("#userAttachedPoliciesModal").modal("show");
}

$(document).on("click", ".detach-user-policy-btn", function() {
    const policyArn = $(this).data("policy-arn");
    detachUserPolicy(policyArn);
});

function detachUserPolicy(policyArn) {
    fetch("/detach_user_policy", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username: currentAttachedUserName, policy_arn: policyArn })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Detached successfully',
                timer: 1500,
                showConfirmButton: false
            }).then(() => openUserAttachedPoliciesModal(currentAttachedUserName));
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'Failed to detach policy'
            });
        }
    });
}

// Attach User Policy
$("#attachUserPolicyBtn").on("click", function() {
    const arn = $("#newUserPolicyArn").val().trim();
    if (!arn) {
        Swal.fire({
            icon: 'warning',
            title: 'Enter Policy ARN',
            timer: 1500,
            showConfirmButton: false
        });
        return;
    }

    fetch("/attach_user_policy", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username: currentAttachedUserName, policy_arn: arn })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            $("#newUserPolicyArn").val("");
            Swal.fire({
                icon: 'success',
                title: 'Policy attached',
                timer: 1500,
                showConfirmButton: false
            }).then(() => openUserAttachedPoliciesModal(currentAttachedUserName));
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'Failed to attach policy'
            });
        }
    });
});

    // ========== PAGINATION AND SEARCH ==========
    const $table = $("#iamUsersTable");
    const $rows = $table.find("tbody tr");
    const $pagination = $("#pagination");
    const $rowsPerPageSelect = $("#rowsPerPageSelect");

    let currentPage = 1;
    let rowsPerPage = parseInt($rowsPerPageSelect.val());

    function renderTable() {
        const visibleRows = $rows.filter(function() {
            return $(this).is(":visible") || $("#searchUserInput").val() === "";
        });
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        $rows.hide();
        visibleRows.slice(start, end).show();
        renderPagination(visibleRows.length);
    }

    function renderPagination(totalRows) {
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        $pagination.empty();

        // Previous
        const prevLi = $('<li class="page-item"></li>');
        if (currentPage === 1) prevLi.addClass("disabled");
        const prevA = $('<a class="page-link" href="#">«</a>');
        prevA.click(function(e){
            e.preventDefault();
            if(currentPage > 1){
                currentPage--;
                renderTable();
            }
        });
        prevLi.append(prevA);
        $pagination.append(prevLi);

        // Page numbers
        for(let i = 1; i <= totalPages; i++){
            const li = $('<li class="page-item"></li>');
            if(i === currentPage) li.addClass("active");
            const a = $('<a class="page-link" href="#">'+i+'</a>');
            a.click(function(e){
                e.preventDefault();
                currentPage = i;
                renderTable();
            });
            li.append(a);
            $pagination.append(li);
        }

        // Next
        const nextLi = $('<li class="page-item"></li>');
        if (currentPage === totalPages) nextLi.addClass("disabled");
        const nextA = $('<a class="page-link" href="#">»</a>');
        nextA.click(function(e){
            e.preventDefault();
            if(currentPage < totalPages){
                currentPage++;
                renderTable();
            }
        });
        nextLi.append(nextA);
        $pagination.append(nextLi);
    }

    $rowsPerPageSelect.change(function(){
        rowsPerPage = parseInt($(this).val());
        currentPage = 1;
        renderTable();
    });

    // Search User by UserName
    $("#searchUserInput").on("keyup", function() {
        const value = $(this).val().toLowerCase();
        $rows.each(function() {
            const username = $(this).find("td:first").text().toLowerCase();
            if (username.includes(value)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
        currentPage = 1;
        renderTable();
    });

    // Initialize
    renderTable();

    // Toast message for user creation
    const msg = localStorage.getItem("userCreatedMsg");
    if (msg) {
        const $toast = $(`
            <div class="animate__animated animate__fadeInDown animate__faster shadow rounded d-flex align-items-center"
                 role="alert"
                 style="position:fixed; top:16px; right:16px; z-index:1060; min-width:260px; padding:12px 16px; background:#1e7e34; color:white;">
                <div style="font-size:1.25rem; margin-right:10px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div style="flex:1; text-align:left; font-weight:600;">
                    ${msg}
                </div>
                <button type="button" class="close" aria-label="Close" style="background:none; border:0; color:white; font-size:1.2rem; margin-left:8px;">
                    &times;
                </button>
            </div>
        `);
        $('body').append($toast);
        const autoClose = setTimeout(() => {
            $toast.removeClass('animate__fadeInDown').addClass('animate__fadeOutUp');
            $toast.one('animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd', function () {
                $toast.remove();
            });
        }, 3000);
        $toast.find('.close').on('click', function () {
            clearTimeout(autoClose);
            $toast.removeClass('animate__fadeInDown').addClass('animate__fadeOutUp');
            $toast.one('animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd', function () {
                $toast.remove();
            });
        });
        localStorage.removeItem("userCreatedMsg");
    }
});

// Helper Functions
function showCustomAlert(message, type="danger") {
    const alertBox = $(`
        <div class="alert alert-${type} alert-dismissible fade show shadow" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `);
    $("#customAlertContainer").append(alertBox);
    setTimeout(() => {
        alertBox.alert('close');
    }, 4000);
}

function showKeyAlert(accessKey, secretKey) {
    const $alert = $(`
        <div class="animate__animated animate__fadeInDown shadow rounded"
             style="position:fixed; top:20px; left:50%; transform:translateX(-50%);
                    z-index:2000; min-width:320px; max-width:400px; padding:20px;
                    background:#1e7e34; color:white; font-family:sans-serif;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>New Access Key Created</strong>
                <button type="button" class="close"
                        style="background:none; border:0; color:white; font-size:1.2rem;">&times;</button>
            </div>
            <div style="margin-top:10px;">
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:5px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="word-break:break-all;">Access Key: ${accessKey}</span>
                    <button class="btn btn-light btn-sm copyBtn">Copy</button>
                </div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:5px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="word-break:break-all;">Secret Key: ${secretKey}</span>
                    <button class="btn btn-light btn-sm copyBtn">Copy</button>
                </div>
                <div id="copyMessage" style="text-align:center; margin-top:10px; font-size:0.9rem; opacity:0; transition:opacity 0.3s;">Copied!</div>
            </div>
        </div>
    `);
    $('body').append($alert);
    $alert.find('.close').on('click', function() {
        $alert.removeClass('animate__fadeInDown').addClass('animate__fadeOutUp');
        $alert.one('animationend', () => $alert.remove());
    });
    $alert.find('.copyBtn').on('click', function() {
        const textToCopy = $(this).siblings('span').text().split(': ')[1];
        navigator.clipboard.writeText(textToCopy).then(() => {
            const $msg = $alert.find('#copyMessage');
            $msg.css('opacity', '1');
            setTimeout(() => $msg.css('opacity', '0'), 1000);
        });
    });
}

function showErrorAlert(msg) {
    const $alert = $(`
        <div class="animate__animated animate__shakeX shadow rounded"
             style="position:fixed; top:20px; left:50%; transform:translateX(-50%);
                    z-index:2000; min-width:300px; max-width:400px; padding:20px;
                    background:#dc3545; color:white; font-family:sans-serif;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>Error</strong>
                <button type="button" class="close"
                        style="background:none; border:0; color:white; font-size:1.2rem;">&times;</button>
            </div>
            <div style="margin-top:10px; font-size:0.95rem;">${msg}</div>
        </div>
    `);
    $('body').append($alert);
    const timer = setTimeout(() => {
        $alert.removeClass('animate__shakeX').addClass('animate__fadeOutUp');
        $alert.one('animationend', () => $alert.remove());
    }, 3000);
    $alert.find('.close').on('click', function() {
        clearTimeout(timer);
        $alert.removeClass('animate__shakeX').addClass('animate__fadeOutUp');
        $alert.one('animationend', () => $alert.remove());
    });
}
</script>

   </body>
</html>