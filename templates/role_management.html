<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>IAM Roles Manager</title>
<link rel="icon" type="image/svg" href="{{ url_for('static', filename='img/aws-logo.svg') }}">
<link href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="{{ url_for('static', filename='css/sb-admin-2.min.css') }}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; background:#f5f7fb; }
.card { border-radius: 12px; box-shadow: 0 6px 18px rgba(39,55,77,0.06); }
.table-hover tbody tr:hover { transform: translateY(-3px); background: #f1f7ff; transition: all .18s ease; }
.toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1080; }
.policy-list-container { max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; background: #f8f9fa; padding: 0.5rem; }
.small-muted { color:#6c757d; font-size:.9rem; }
.page-controls { gap:1rem; align-items:center; display:flex; }
.page-size { min-width:80px; }
.no-roles { padding:2rem; text-align:center; color:#6c757d; }

.page-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 1.5rem;
    padding: 1rem 0;
    flex-wrap: wrap;
    gap: 1rem;
}
.search-section {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.search-section .form-control {
    min-width: 280px;
}

.policy-table {
    margin-bottom: 0;
}
.policy-table thead th {
    border-bottom: 1px solid #dee2e6;
    background-color: #f8f9fa;
    font-weight: 600;
    padding: 0.75rem;
}
.policy-table tbody td {
    padding: 0.75rem;
    vertical-align: middle;
}
.policy-table-container {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: #fff;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: stretch;
    }
    .search-section {
        justify-content: space-between;
    }
    .search-section .form-control {
        min-width: auto;
        flex: 1;
    }
}
</style>
</head>
<body id="page-top">

<div id="wrapper">
  <!-- Sidebar -->
  <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
    <a class="sidebar-brand d-flex align-items-center justify-content-center">
      <div class="sidebar-brand-icon rotate-n-13"><i class="fab fa-aws" style="color: orange;"></i></div>
      <div class="sidebar-brand-text mx-3">S3 Panel</div>
    </a>
            {% if user_info.type == "Root Account" %}
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('bucket.home') }}">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span></a>
            </li>
            {% endif %}
    <hr class="sidebar-divider">
    <div class="sidebar-heading">Interface</div>
<!-- Nav Item - Pages Collapse Menu -->
<li class="nav-item">
    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseBuckets"
        aria-expanded="true" aria-controls="collapseBuckets">
        <i class="fa fa-cubes" aria-hidden="true"></i>
        <span>Buckets</span>
    </a>
    <div id="collapseBuckets" class="collapse" aria-labelledby="headingBuckets" data-parent="#accordionSidebar">
        <div class="bg-white py-2 collapse-inner rounded">
            <a class="collapse-item" href="{{ url_for('bucket.buckets') }}">Buckets</a>
        </div>
    </div>
</li>

<!-- Nav Item - Objects Collapse Menu -->
<li class="nav-item">
    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseObjects"
        aria-expanded="true" aria-controls="collapseObjects">
        <i class="fas fa-database"></i>
        <span>Objects</span>
    </a>
    <div id="collapseObjects" class="collapse" aria-labelledby="headingObjects" data-parent="#accordionSidebar">
        <div class="bg-white py-2 collapse-inner rounded">
            <a class="collapse-item" href="{{ url_for('objects.all_buckets') }}">Objects</a>
        </div>
    </div>
</li>

    <li class="nav-item">
      <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseS3select">
<i class="fas fa-table"></i><span>S3select</span>
      </a>
      <div id="collapseS3select" class="collapse">
        <div class="bg-white py-2 collapse-inner rounded">
          <a class="collapse-item" href="{{ url_for('s3_select.s3_select_page') }}">S3select</a>
        </div>
      </div>
    </li>
            <!-- Nav Item - Utilities Collapse Menu -->
            {% if user_info.type == "Root Account" %}
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                    aria-expanded="true" aria-controls="collapseUtilities">
                    <i class="fa fa-key" aria-hidden="true"></i>
                    <span>IAM</span>
                </a>
                <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                    data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="{{ url_for('user.iam_users') }}">Users</a>
                        <a class="collapse-item" href="{{ url_for('iam_groups.iam_groups') }}">Groups</a>
                    </div>
                </div>
            </li>
            {% endif %}

<li class="nav-item">
    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseSts"
        aria-expanded="true" aria-controls="collapseSts">
        <i class="fas fa-theater-masks"></i>
        <span>STS</span>
    </a>

    <div id="collapseSts" class="collapse show" aria-labelledby="headingObjects" data-parent="#accordionSidebar">
        <div class="bg-white py-2 collapse-inner rounded">
            {% if user_info.type == "Root Account" %}

            <a class="collapse-item" href="{{ url_for('manage.manage_sts_permissions') }}">Admin Permission</a>
            <a class="collapse-item active" href="{{ url_for('manage_iam.manage_roles_page') }}">Role Management</a>
             {% endif %}
              {% if user_info.type != "Root Account" %}
              <a class="collapse-item" href="{{ url_for('assume_roles.assume_roles_page') }}">Assume Role</a">
              {% endif %}

        </div>
    </div>

</li>
            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('user.profile') }}">
                    <i class="fas fa-fw fa-user"></i>
                    <span>Profile</span>
                </a>
            </li>
            </li>

    <!-- <hr class="sidebar-divider d-none d-md-block"> -->
    <div class="text-center d-none d-md-inline">
      <button class="rounded-circle border-0" id="sidebarToggle"></button>
    </div>
  </ul>
  <!-- End Sidebar -->

  <div id="content-wrapper" class="d-flex flex-column">
    <div id="content">
      <!-- Topbar -->
      <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
          <i class="fa fa-bars"></i>
        </button>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown no-arrow">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="mr-2 d-none d-lg-inline text-gray-600 small">
                {{ user_info.UserName or "No Name" }}
                {% if user_info.type %}({{ user_info.type }}){% endif %}
              </span>
              <img class="img-profile rounded-circle" src="{{ url_for('static', filename='img/undraw_profile.svg') }}">
            </a>
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
              <a class="dropdown-item" href="{{ url_for('user.profile') }}">
                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> Profile
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i> Logout
              </a>
            </div>
          </li>
        </ul>
      </nav>
      <!-- End Topbar -->

      <!-- Page Content -->
      <div class="container-fluid">
        <div class="page-header">
          <button id="createBtn" class="btn btn-success">
            <i class="fas fa-plus-circle me-2"></i>Create Role
          </button>
          
          <div class="search-section">
            <i class="fas fa-search text-muted"></i>
            <input id="searchBox" class="form-control" placeholder="Search roles...">
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body p-0">
            <table class="table table-hover mb-0">
              <thead class="bg-light">
                <tr>
                  <th style="width:20%;">Role Name</th>
                  <th>ARN</th>
                  <th style="width:18%;">Create Date</th>
                  <th style="width:200px;">Policies</th>
                  <th style="width:120px;">Actions</th>
                </tr>
              </thead>
              <tbody id="rolesTbody"></tbody>
            </table>
          </div>
          <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="page-controls">
              <label class="mb-0 small-muted">Page size:</label>
              <select id="pageSize" class="form-select form-select-sm page-size">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
              </select>
            </div>
            <nav>
              <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="sticky-footer bg-white">
      <div class="container my-auto">
        <div class="copyright text-center my-auto">
          <span>Copyright &copy; Your Website 2025</span>
        </div>
      </div>
    </footer>
  </div>
</div>

<!-- Modals: Role Modal, Policy Modal, Confirm Modal, Logout Modal -->
<!-- Role Modal -->
<div class="modal fade" id="roleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="roleModalTitle">Create Role</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="roleForm">
          <div class="mb-3">
            <label class="form-label">Role Name</label>
            <input id="roleName" class="form-control" required />
            <div class="form-text small-muted">When editing, role name cannot be changed.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Trust Policy (JSON)</label>
            <textarea id="trustJson" rows="10" class="form-control" spellcheck="false"
              style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;"></textarea>
          </div>
        </form>
        <div id="modalAlert" class="mt-2"></div>
      </div>
      <div class="modal-footer">
        <button id="saveRoleBtn" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Policy Modal -->
<div class="modal fade" id="policyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="policyModalTitle">Manage Policies</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="policy-table-container">
            <table class="table table-sm policy-table mb-0">
              <thead>
                <tr>
                  <th style="width:70%">Policy Name</th>
                  <th style="width:30%">Actions</th>
                </tr>
              </thead>
              <tbody id="policyTableBody">
                <tr><td colspan="2" class="text-center py-2">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">New Policy Name</label>
          <input id="policyName" class="form-control"/>
        </div>
        <div class="mb-3">
          <label class="form-label">Policy Document (JSON)</label>
          <textarea id="policyDoc" rows="8" class="form-control" spellcheck="false"
            style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button id="addPolicyBtn" class="btn btn-success">Add / Update Policy</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h6 class="modal-title">Confirm delete</h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" class="mb-0">Are you sure?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button id="confirmDeleteBtn" class="btn btn-danger">Delete Role</button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
      <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <a class="btn btn-primary" href="{{ url_for('auth.logout') }}">Logout</a>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/jquery-easing/jquery.easing.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
/* ====== State ====== */
let roles = [];
let filteredRoles = [];
let currentPage = 1;
let pageSize = parseInt(document.getElementById('pageSize').value);
let editing = null;
let deleteTarget = null;
let currentPolicyRole = null;

/* ====== Elements ====== */
const rolesTbody = document.getElementById('rolesTbody');
const searchBox = document.getElementById('searchBox');
const pageSizeSelect = document.getElementById('pageSize');
const pagination = document.getElementById('pagination');
const createBtn = document.getElementById('createBtn');
const saveRoleBtn = document.getElementById('saveRoleBtn');
const roleModal = new bootstrap.Modal(document.getElementById('roleModal'));
const policyModal = new bootstrap.Modal(document.getElementById('policyModal'));
const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
const confirmMessageEl = document.getElementById('confirmMessage');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const toastContainer = document.getElementById('toastContainer');
const roleNameInput = document.getElementById('roleName');
const trustJsonInput = document.getElementById('trustJson');

const policyListEl = document.getElementById('policyList');
const policyNameInput = document.getElementById('policyName');
const policyDocInput = document.getElementById('policyDoc');
const addPolicyBtn = document.getElementById('addPolicyBtn');

/* ====== Helpers ====== */
function showToast(type, message) {
  const colorClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-secondary';
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white ${colorClass} border-0 mb-2`;
  toast.setAttribute('role','alert');
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
    </div>`;
  toastContainer.appendChild(toast);
  const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
  bsToast.show();
  toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

function safeJSONParse(str) {
  try { return JSON.parse(str); } catch(e) { return null; }
}

/* ====== Fetch roles ====== */
async function loadRoles(){
  rolesTbody.innerHTML = `<tr><td colspan="5" class="text-center py-3">Loading...</td></tr>`;
  try {
    const res = await fetch('/api/roles');
    const j = await res.json();
    if (j.error) { showToast('danger', j.error); roles = []; filteredRoles = []; renderTable(); return; }
    roles = j.roles || [];
    roles.sort((a,b)=> a.RoleName.localeCompare(b.RoleName));
    filteredRoles = roles;
    currentPage = 1;
    renderTable();
  } catch (err) {
    showToast('danger', 'Failed to load roles: ' + err.message);
    roles = []; filteredRoles = [];
    renderTable();
  }
}

/* ====== Render table & pagination ====== */
function renderTable(){
  if (!filteredRoles || filteredRoles.length === 0) {
    rolesTbody.innerHTML = `<tr><td colspan="5" class="no-roles">No roles found</td></tr>`;
  } else {
    const start = (currentPage - 1) * pageSize;
    const pageItems = filteredRoles.slice(start, start + pageSize);
    rolesTbody.innerHTML = pageItems.map(r=>{
      const createDate = r.CreateDate ? new Date(r.CreateDate).toLocaleString() : '';
      return `
        <tr>
          <td class="align-middle">${r.RoleName}</td>
          <td class="align-middle" style="max-width:420px;word-break:break-all">${r.Arn}</td>
          <td class="align-middle">${createDate}</td>
          <td class="align-middle text-start">
            <div id="policyContainer-${r.RoleName}">
              <button class="btn btn-sm btn-outline-secondary" onclick="onManagePolicies('${r.RoleName}')">
                Manage Policies
              </button>
            </div>
          </td>
          <td class="align-middle text-center">
            <button class="btn btn-sm btn-outline-primary me-1" title="Edit" data-role="${encodeURIComponent(r.RoleName)}" onclick="onEditClick(event)">
              <i class="fas fa-pen"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" title="Delete" data-role="${encodeURIComponent(r.RoleName)}" onclick="onDeleteClick(event)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>`;
    }).join('');
  }
  renderPagination();
}

function renderPagination(){
  const totalPages = Math.max(1, Math.ceil(filteredRoles.length / pageSize));
  pagination.innerHTML = '';
  if (totalPages <= 1) return;

  const prevLi = document.createElement('li');
  prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
  prevLi.innerHTML = `<a class="page-link" href="#">Previous</a>`;
  prevLi.onclick = (e)=>{ e.preventDefault(); if (currentPage>1){ currentPage--; renderTable(); } };
  pagination.appendChild(prevLi);

  const start = Math.max(1, currentPage-1);
  const end = Math.min(totalPages, currentPage+1);
  for (let i=start;i<=end;i++){
    const li = document.createElement('li');
    li.className = 'page-item' + (i === currentPage ? ' active' : '');
    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
    li.onclick = (e)=>{ e.preventDefault(); currentPage = i; renderTable(); };
    pagination.appendChild(li);
  }

  const nextLi = document.createElement('li');
  nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
  nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
  nextLi.onclick = (e)=>{ e.preventDefault(); if (currentPage<totalPages){ currentPage++; renderTable(); } };
  pagination.appendChild(nextLi);
}

/* ====== Policy management ====== */
async function onManagePolicies(roleName){
  currentPolicyRole = roleName;
  policyModal.show();
  policyNameInput.value = '';
  policyDocInput.value = '';
  const tbody = document.getElementById('policyTableBody');
  tbody.innerHTML = `<tr><td colspan="2" class="text-center py-2">Loading...</td></tr>`;

  try {
    const res = await fetch(`/api/role/${encodeURIComponent(roleName)}/policies`);
    const j = await res.json();
    if (j.error){ showToast('danger', j.error); tbody.innerHTML=''; return; }
    const policies = j.policies || [];
    if(policies.length===0){
      tbody.innerHTML = `<tr><td colspan="2" class="text-center py-2">No policies</td></tr>`;
      return;
    }
    tbody.innerHTML = policies.map(p=>`
      <tr>
        <td>${p}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1" onclick="onEditPolicy('${p}')">
            <i class="fas fa-pen"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="onDeletePolicy('${p}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `).join('');
  } catch(err){
    showToast('danger', 'Failed to load policies: ' + err.message);
    tbody.innerHTML = '';
  }
}


async function onEditPolicy(policyName){
  policyNameInput.value = policyName;
  try {
    const res = await fetch(`/api/role/${encodeURIComponent(currentPolicyRole)}/policy/${encodeURIComponent(policyName)}`);
    const j = await res.json();
    if (j.error){ showToast('danger', j.error); return; }
    policyDocInput.value = JSON.stringify(j.policy.PolicyDocument, null, 2);
  } catch(err){
    showToast('danger', 'Failed to fetch policy: ' + err.message);
  }
}

async function onDeletePolicy(policyName){
  const result = await Swal.fire({
    title: 'Delete Policy?',
    html: `Are you sure you want to delete policy <strong>"${policyName}"</strong> from role <strong>"${currentPolicyRole}"</strong>?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Yes, delete it!',
    cancelButtonText: 'Cancel',
    background: '#f8f9fa',
    backdrop: 'rgba(0,0,0,0.4)',
    customClass: {
      popup: 'border-radius-12',
      confirmButton: 'btn-danger',
      cancelButton: 'btn-secondary'
    }
  });

  if (result.isConfirmed) {
    try {
      const res = await fetch(`/api/role/${encodeURIComponent(currentPolicyRole)}/policy/${encodeURIComponent(policyName)}`, { 
        method: 'DELETE' 
      });
      const j = await res.json();
      if (j.error) {
        await Swal.fire({
          title: 'Error!',
          text: j.error,
          icon: 'error',
          confirmButtonColor: '#d33'
        });
      } else {
        await Swal.fire({
          title: 'Deleted!',
          text: 'Policy has been deleted.',
          icon: 'success',
          confirmButtonColor: '#3085d6'
        });
        onManagePolicies(currentPolicyRole);
      }
    } catch(err) {
      await Swal.fire({
        title: 'Error!',
        text: 'Failed to delete policy: ' + err.message,
        icon: 'error',
        confirmButtonColor: '#d33'
      });
    }
  }
}

addPolicyBtn.addEventListener('click', async ()=>{
  const name = policyNameInput.value.trim();
  if (!name){ showToast('danger', 'Policy name required'); return; }
  const doc = safeJSONParse(policyDocInput.value);
  if (!doc){ showToast('danger', 'Invalid JSON'); return; }

  try {
    const res = await fetch(`/api/role/${encodeURIComponent(currentPolicyRole)}/policy/${encodeURIComponent(name)}`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ policyDocument: doc })
    });
    const j = await res.json();
    if (j.error) showToast('danger', j.error);
    else { showToast('success', 'Policy saved'); onManagePolicies(currentPolicyRole); }
  } catch(err){
    showToast('danger', 'Failed to save policy: ' + err.message);
  }
});

/* ====== Search & page size ====== */
searchBox.addEventListener('input', ()=>{
  const q = searchBox.value.trim().toLowerCase();
  filteredRoles = roles.filter(r => r.RoleName.toLowerCase().includes(q));
  currentPage = 1;
  renderTable();
});

pageSizeSelect.addEventListener('change', ()=>{
  pageSize = parseInt(pageSizeSelect.value);
  currentPage = 1;
  renderTable();
});

/* ====== Create / Edit Role ====== */
createBtn.addEventListener('click', ()=>{
  editing = null;
  document.getElementById('roleModalTitle').textContent = 'Create Role';
  roleNameInput.disabled = false;
  roleNameInput.value = '';
  trustJsonInput.value = JSON.stringify({
    "Version":"2012-10-17",
    "Statement":[{"Effect":"Allow","Principal":{"AWS":"arn:aws:iam::123456789012:root"},"Action":"sts:AssumeRole"}]
  }, null, 2);
  document.getElementById('modalAlert').innerHTML = '';
  saveRoleBtn.innerText = 'Create Role';
  roleModal.show();
});

async function onEditClick(e){
  const encName = e.currentTarget.getAttribute('data-role');
  const name = decodeURIComponent(encName);
  try {
    const res = await fetch(`/api/role/${encodeURIComponent(name)}`);
    const j = await res.json();
    if (j.error){ showToast('danger', j.error); return; }
    editing = name;
    document.getElementById('roleModalTitle').textContent = `Edit Role: ${name}`;
    roleNameInput.value = name;
    roleNameInput.disabled = true;
    const trust = j.assumeRolePolicy || j.role && j.role.AssumeRolePolicyDocument;
    trustJsonInput.value = JSON.stringify(trust || {}, null, 2);
    document.getElementById('modalAlert').innerHTML = '';
  saveRoleBtn.innerText = 'Update Trust';
  roleModal.show();
  } catch(err) {
    showToast('danger', 'Failed to fetch role: ' + err.message);
  }
}

saveRoleBtn.addEventListener('click', async ()=>{
  const name = roleNameInput.value.trim();
  if (!name) { showToast('danger', 'Role name required'); return; }
  const parsed = safeJSONParse(trustJsonInput.value);
  if (!parsed) { showToast('danger', 'Invalid JSON in trust policy'); return; }

  try {
    if (editing) {
      const res = await fetch('/api/role/update_assume', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ roleName: editing, trustJson: parsed })
      });
      const j = await res.json();
      if (j.error){ showToast('danger', j.error); }
      else { showToast('success', 'Trust policy updated'); roleModal.hide(); await loadRoles(); }
    } else {
      const res = await fetch('/api/role/create', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ roleName: name, trustJson: parsed })
      });
      const j = await res.json();
      if (j.error){ showToast('danger', j.error); }
      else { showToast('success', 'Role created'); roleModal.hide(); await loadRoles(); }
    }
  } catch(err) {
    showToast('danger', 'Request failed: ' + err.message);
  }
});

/* ====== Delete Role ====== */
function onDeleteClick(e){
  const encName = e.currentTarget.getAttribute('data-role');
  const name = decodeURIComponent(encName);
  deleteTarget = name;
  confirmMessageEl.textContent = `Are you sure you want to delete role "${name}"? This cannot be undone.`;
  confirmDeleteBtn.textContent = 'Delete Role';
  confirmModal.show();
}

confirmDeleteBtn.addEventListener('click', async ()=>{
  if (!deleteTarget) return;
  try {
    const res = await fetch(`/api/role/delete/${encodeURIComponent(deleteTarget)}`, { method: 'DELETE' });
    const j = await res.json();
    if (j.error) { showToast('danger', j.error); }
    else { showToast('success', `Role "${deleteTarget}" deleted`); }
    deleteTarget = null;
    confirmModal.hide();
    await loadRoles();
  } catch (err) {
    showToast('danger', 'Delete failed: ' + err.message);
  }
});

/* ====== Init ====== */
window.addEventListener('load', loadRoles);
window.onEditClick = onEditClick;
window.onDeleteClick = onDeleteClick;
window.onManagePolicies = onManagePolicies;
window.onEditPolicy = onEditPolicy;
window.onDeletePolicy = onDeletePolicy;
</script>
</body>
</html>